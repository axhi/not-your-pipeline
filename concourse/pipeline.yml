---
jobs:
- name: run-unit-test
  public: true
  plan:
  - aggregate:
    - get: src
      trigger: true
    - get: ci
  - task: unit-test
    file: ci/concourse/tasks/run-unit-test.yml
- name: deploy-dev
  plan:
  - aggregate:
    - get: src
      trigger: true
      passed: ["run-unit-test"]
    - get: ci
  - task: build-app
    file: ci/concourse/tasks/build-app.yml
  - put: cf-deploy
    params:
      manifest: src/app/manifest.yml
      path: build-output/

resources:
- name: src
  type: git
  source:
    uri: https://github.com/axhi/not-your-pipeline
    paths: ["app"]
- name: ci
  type: git
  source:
    uri: https://github.com/axhi/not-your-pipeline
    paths: ["concourse"]
- name: cf-deploy
  type: cf
  source:
    api: https://api.run.pivotal.io
    username: {{pcf-user}}
    password: {{pcf-pass}}
    organization: asabani-org
    space: development